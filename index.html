<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Opti Solar ‚Äì v2.5.2</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com/3.4.3"></script>
  <!-- Capacitor core (for Haptics detection in the WebView build) -->
  <script src="https://unpkg.com/@capacitor/core@5.7.4/dist/capacitor.js"></script>
  <!-- html2pdf for export -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    :root{
      --bg:#0b1220;--card:#121a2b;--muted:#7b8aa5;--fg:#e9f0ff;--accent:#41d1b7;--bad:#ff6b6b;--ok:#31d087;--btn2:#2a3957
    }
    body{background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .btn-primary{background:var(--accent);color:#00110e}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-secondary{background:var(--btn2);color:var(--fg)}
    .btn-danger{background:var(--bad);color:#fff}
    .bg-input{background:#0e1423;border:1px solid rgba(255,255,255,.1);color:var(--fg)}
    /* memorize ring */
    .ring{width:120px;height:120px;border-radius:9999px;border:6px solid #375070;position:relative;display:flex;align-items:center;justify-content:center}
    .ring.ok{border-color:var(--ok)}
    .ring::after{content:"";position:absolute;inset:-6px;border-radius:9999px;border:6px solid transparent;border-top-color:var(--accent);animation:spin 1.2s linear infinite;opacity:.25}
    .ring.paused::after{animation-play-state:paused;opacity:.12}
    @keyframes spin{to{transform:rotate(360deg)}}
    .shockwave{position:absolute;inset:0;border-radius:9999px;border:2px solid var(--accent);opacity:0;}
    .shockwave.run{animation:wave .6s ease-out}
    @keyframes wave{0%{transform:scale(1);opacity:.6}100%{transform:scale(1.6);opacity:0}}
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="flex-shrink-0 w-full max-w-lg mx-auto p-4 flex justify-between items-center">
    <div id="lang-switcher" class="flex gap-2">
      <button data-lang="fr" class="px-3 py-2 rounded-full bg-[color:var(--card)] text-[color:var(--muted)] font-bold">FR</button>
      <button data-lang="en" class="px-3 py-2 rounded-full bg-[color:var(--card)] text-[color:var(--muted)] font-bold">EN</button>
    </div>
    <div class="text-xs text-gray-500">v2.5.2</div>
  </header>

  <!-- Main -->
  <main class="flex-1 px-4">
    <div id="app" class="w-full max-w-lg mx-auto card rounded-2xl p-6 md:p-8 space-y-6">

      <!-- PAGE: Mesure / R√©glage -->
      <section id="main-page">
        <h1 class="text-2xl md:text-3xl font-extrabold text-center">Opti Solar</h1>

        <div class="mt-4">
          <label class="block text-sm text-gray-400 mb-1" data-i18n="location"></label>
          <div class="flex gap-2 items-center">
            <input id="latitude-input" type="number" step="any" class="bg-input w-full p-2 rounded-md" data-i18n-placeholder="latitude_placeholder"/>
            <button id="get-location" class="btn-secondary px-3 py-2 rounded-md" title="GPS">
              üß≠
            </button>
          </div>
          <p id="location-subtitle" class="text-sm text-gray-400 mt-2 h-4"></p>
          <p id="location-error" class="text-xs text-red-400 h-4"></p>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4">
          <button id="activate-sensors-button" class="btn-primary font-bold py-2 px-4 rounded-lg" data-i18n="activate_sensors"></button>
          <button id="manual-entry-button" class="btn-secondary font-bold py-2 px-4 rounded-lg" data-i18n="manual_entry"></button>
        </div>

        <!-- Sensors UI -->
        <div id="sensors-display" class="hidden space-y-4 pt-4 mt-4 border-t border-gray-800">
          <div class="grid grid-cols-2 gap-4 text-center">
            <div>
              <p class="text-lg text-gray-400" data-i18n="current_angle"></p>
              <p class="text-4xl font-bold my-1"><span id="current-angle">--</span>¬∞</p>
            </div>
            <div>
              <p class="text-lg text-gray-400" data-i18n="orientation"></p>
              <p class="text-xl font-bold my-1"><span id="current-compass">--</span></p>
            </div>
          </div>

          <!-- Mem ring -->
          <div class="flex flex-col items-center gap-3">
            <div class="relative">
              <div id="memorize-ring" class="ring paused">
                <div class="shockwave" id="ring-wave"></div>
                <span id="memorize-ring-label" class="text-sm text-gray-300" data-i18n="memorize_action">M√©moriser</span>
              </div>
            </div>
            <p id="sensor-error" class="text-xs text-red-400 h-4 text-center"></p>
          </div>
        </div>

        <!-- Manual entry UI -->
        <div id="manual-entry-display" class="hidden space-y-4 pt-4 mt-4 border-t border-gray-800">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="manual-tilt-input" class="block text-sm text-gray-400 mb-1" data-i18n="tilt"></label>
              <input id="manual-tilt-input" type="number" class="bg-input w-full p-2 rounded-md text-center" data-i18n-placeholder="tilt_placeholder"/>
            </div>
            <div>
              <label for="manual-azimuth-input" class="block text-sm text-gray-400 mb-1" data-i18n="orientation_short"></label>
              <p class="text-xs text-gray-500 -mt-1 mb-2 text-center" data-i18n="orientation_helper"></p>
              <input id="manual-azimuth-input" type="number" class="bg-input w-full p-2 rounded-md text-center" data-i18n-placeholder="orientation_placeholder"/>
            </div>
          </div>
        </div>

        <!-- Result & seasonal cards -->
        <div id="result-container" class="text-center mt-6 hidden">
          <p class="text-lg text-teal-300" data-i18n="recommended_angle"></p>
          <p id="result" class="text-5xl md:text-6xl font-bold text-teal-400 my-1">--¬∞</p>
        </div>

        <div class="mt-6">
          <label for="date-input" class="block text-md font-medium text-teal-300 mb-2" data-i18n="target_date"></label>
          <input id="date-input" type="date" class="w-full p-2 rounded-lg bg-input" />
        </div>

        <div id="seasonal-container" class="mt-6 hidden">
          <h2 class="text-xl font-bold text-center mb-4" data-i18n="seasonal_settings"></h2>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
            <div class="bg-gray-900/50 rounded-lg p-4">
              <p class="font-bold text-lg" data-i18n="winter"></p>
              <p id="winter-angle" class="text-3xl font-bold text-sky-400">--¬∞</p>
              <p class="text-xs text-gray-500" data-i18n="winter_date"></p>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-4">
              <p class="font-bold text-lg" data-i18n="mid_season"></p>
              <p id="spring-fall-angle" class="text-3xl font-bold text-amber-400">--¬∞</p>
              <p class="text-xs text-gray-500" data-i18n="mid_season_date"></p>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-4">
              <p class="font-bold text-lg" data-i18n="summer"></p>
              <p id="summer-angle" class="text-3xl font-bold text-red-400">--¬∞</p>
              <p class="text-xs text-gray-500" data-i18n="summer_date"></p>
            </div>
          </div>
        </div>

        <button id="goto-estimation-button" class="hidden mt-6 w-full btn-primary font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center">
          <span data-i18n="calculate_gain"></span>
        </button>
      </section>

      <!-- PAGE: Estimation / PVGIS -->
      <section id="settings-page" class="hidden">
        <button id="back-button" class="absolute top-4 left-4 p-2 rounded-full bg-gray-800 hover:bg-gray-700" aria-label="Back">‚Üê</button>
        <h2 class="text-2xl md:text-3xl font-bold text-center pt-8" data-i18n="estimation_title"></h2>

        <div class="space-y-4 mt-6">
          <div>
            <label for="peak-power" class="block text-sm text-gray-400" data-i18n="peak_power"></label>
            <input id="peak-power" type="number" value="3.72" class="mt-1 w-full p-2 bg-input rounded-md" />
          </div>
          <div>
            <label for="longitude-input" class="block text-sm text-gray-400" data-i18n="longitude"></label>
            <input id="longitude-input" type="number" value="4.028" class="mt-1 w-full p-2 bg-input rounded-md" />
          </div>
          <div>
            <label for="current-tilt-input" class="block text-sm text-gray-400" data-i18n="current_tilt"></label>
            <input id="current-tilt-input" type="number" class="mt-1 w-full p-2 bg-input rounded-md" data-i18n-placeholder="tilt_placeholder" />
          </div>
          <div>
            <label for="current-azimuth-input" class="block text-sm text-gray-400" data-i18n="current_azimuth"></label>
            <input id="current-azimuth-input" type="number" class="mt-1 w-full p-2 bg-input rounded-md" data-i18n-placeholder="azimuth_placeholder" />
          </div>
        </div>

        <button id="calculate-production" class="mt-6 w-full btn-primary font-bold py-3 px-4 rounded-lg flex items-center justify-center">
          <span id="calculate-text" data-i18n="calculate_gain_long"></span>
          <div id="calculate-loader" class="ml-3 hidden">
            <div class="w-5 h-5 border-4 border-[color:var(--btn2)] border-t-[color:var(--accent)] rounded-full animate-spin"></div>
          </div>
        </button>

        <div id="production-results" class="mt-6 space-y-4 hidden">
          <div class="bg-gray-900/50 p-4 rounded-lg text-center">
            <p class="text-sm text-gray-400" data-i18n="prod_current_settings"></p>
            <p id="current-production" class="text-2xl font-bold">-- kWh</p>
          </div>
          <div class="bg-green-900/30 p-4 rounded-lg text-center">
            <p class="text-sm text-green-300" data-i18n="prod_optimal_settings"></p>
            <p id="optimal-production" class="text-2xl font-bold text-green-300">-- kWh</p>
          </div>
          <div class="bg-blue-900/30 p-4 rounded-lg text-center">
            <p class="text-sm text-blue-300" data-i18n="daily_gain"></p>
            <p id="potential-gain" class="text-3xl font-bold text-blue-300">~ -- Wh</p>
          </div>
          <div class="bg-blue-900/30 p-4 rounded-lg text-center">
            <p class="text-sm text-blue-300" data-i18n="monthly_gain"></p>
            <p id="potential-gain-monthly" class="text-3xl font-bold text-blue-300">~ -- kWh</p>
          </div>
          <div class="flex justify-center">
            <button id="export-pdf-btn" class="btn-secondary px-4 py-2 rounded-md" data-i18n="export_pdf">Exporter en PDF</button>
          </div>
        </div>
        <p id="pvgis-error" class="text-xs text-red-400 h-4 mt-2 text-center"></p>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="flex-shrink-0 w-full max-w-lg mx-auto p-4 flex justify-between items-center">
    <a id="bug-report-button" href="#" class="px-3 py-2 rounded-full bg-[color:var(--card)] text-yellow-400" title="Bug/Suggestion">üêû</a>
    <p class="text-xs text-gray-600">v2.5.2</p>
    <a id="donate-button-fab" href="https://paypal.me/iFredZ" class="px-3 py-2 rounded-full bg-[color:var(--card)] text-red-400" title="Soutenir">‚ù§</a>
  </footer>

  <!-- Script -->
  <script>
  (function(){
    'use strict';

    const CONFIG = {
      defaultLatitude: 44.21446,
      defaultLongitude: 4.028,
      clippingAdjustment: 10,
      sensorEventName: ('ondeviceorientationabsolute' in window) ? 'deviceorientationabsolute' : 'deviceorientation',
      donateLink: 'https://paypal.me/iFredZ',
      reportEmail: 'finjalrac@gmail.com'
    };

    const translations = {
      fr: {
        activate_sensors: "Utiliser Capteurs",
        stop_sensors: "Arr√™ter Capteurs",
        manual_entry: "Saisie Manuelle",
        location: "Localisation",
        latitude_placeholder: "Latitude requise",
        target_date: "Date Cible",
        current_angle: "Angle Actuel",
        orientation: "Orientation",
        memorize_action: "M√©moriser",
        memorize_action_info: "Quand l'anneau est vert, appuyez",
        memorized: "Valeurs m√©moris√©es !",
        tilt: "Inclinaison (¬∞)",
        tilt_placeholder: "ex: 35",
        orientation_short: "Orientation (¬∞)",
        orientation_helper: "EST (-) | SUD (0) | OUEST (+)",
        orientation_placeholder: "0",
        recommended_angle: "Angle Recommand√©",
        waiting_for_sensor: "Orientez votre appareil‚Ä¶",
        calculate_gain: "Estimez votre production",
        seasonal_settings: "R√©glages Saisonniers",
        winter: "Hiver", winter_date: "~21 D√©c.",
        mid_season: "Mi-saison", mid_season_date: "~20 Mars & ~22 Sep.",
        summer: "√ât√©", summer_date: "~21 Juin",
        estimation_title: "Estimation de Production",
        peak_power: "Puissance cr√™te (kWc)",
        longitude: "Longitude",
        current_tilt: "Inclinaison actuelle (¬∞)",
        current_azimuth: "Orientation actuelle (D√©viation / Sud)",
        azimuth_placeholder: "ex: -10 (10¬∞ Est)",
        calculate_gain_long: "Calculer le gain potentiel",
        prod_current_settings: "Production estim√©e (r√©glage actuel)",
        prod_optimal_settings: "Production estim√©e (r√©glage optimal)",
        daily_gain: "Gain potentiel journalier",
        monthly_gain: "Gain potentiel mensuel",
        export_pdf: "Exporter en PDF",
        export_error_no_data: "Aucune donn√©e √† exporter.",
        pvgis_error: "Erreur communication PVGIS.",
        invalid_measurements: "Mesures invalides.",
        compass_south: "Plein Sud", compass_east: "Est", compass_west: "Ouest"
      },
      en: {
        activate_sensors: "Use Sensors",
        stop_sensors: "Stop Sensors",
        manual_entry: "Manual Input",
        location: "Location",
        latitude_placeholder: "Latitude required",
        target_date: "Target Date",
        current_angle: "Current Angle",
        orientation: "Orientation",
        memorize_action: "Memorize",
        memorize_action_info: "When ring turns green, press",
        memorized: "Values Saved!",
        tilt: "Tilt (¬∞)", tilt_placeholder: "e.g. 35",
        orientation_short: "Orientation (¬∞)",
        orientation_helper: "EAST (-) | SOUTH (0) | WEST (+)",
        orientation_placeholder: "0",
        recommended_angle: "Recommended Angle",
        waiting_for_sensor: "Point your device‚Ä¶",
        calculate_gain: "Estimate your production",
        seasonal_settings: "Seasonal Settings",
        winter: "Winter", winter_date: "~Dec 21",
        mid_season: "Mid-Season", mid_season_date: "~Mar 20 & ~Sep 22",
        summer: "Summer", summer_date: "~Jun 21",
        estimation_title: "Production Estimate",
        peak_power: "Peak Power (kWp)",
        longitude: "Longitude",
        current_tilt: "Current Tilt (¬∞)",
        current_azimuth: "Current Azimuth (Deviation / South)",
        azimuth_placeholder: "e.g. -10 (10¬∞ East)",
        calculate_gain_long: "Calculate potential gain",
        prod_current_settings: "Estimated production (current settings)",
        prod_optimal_settings: "Estimated production (optimal settings)",
        daily_gain: "Potential Daily Gain",
        monthly_gain: "Potential Monthly Gain",
        export_pdf: "Export PDF",
        export_error_no_data: "No data to export.",
        pvgis_error: "PVGIS communication error.",
        invalid_measurements: "Invalid measurements.",
        compass_south: "Due South", compass_east: "East", compass_west: "West"
      }
    };

    const i18n = {
      currentLang: 'fr',
      setLanguage(lang){
        if(!translations[lang]) return;
        this.currentLang = lang; document.documentElement.lang = lang;
        document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.dataset.i18n; if(translations[lang][k]) el.innerHTML = translations[lang][k]; });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ const k=el.dataset.i18nPlaceholder; if(translations[lang][k]) el.placeholder = translations[lang][k]; });
        dom.activateSensorsButton.textContent = state.sensorsActive? translations[lang].stop_sensors : translations[lang].activate_sensors;
        dom.bugReportButton && (dom.bugReportButton.title = lang==='fr'? 'Bug/Suggestion' : 'Bug/Suggestion');
        calculations.calculateAndDisplayAll();
        try{ localStorage.setItem('userLang', lang);}catch{}
      }
    };

    const state = {
      entryMode: null,
      sensorsActive: false,
      currentLongitude: CONFIG.defaultLongitude,
      panelAzimuthLive: null,
      tiltOffset: 0,
      lastRecommendedTilt: null,
      memorizedTilt: null,
      memorizedAzimuthValue: null,
      memorizedLongitude: null,
      lastSensorTs: 0,
      stabilityBuf: [] // last N tilt values
    };

    const dom = {
      // pages
      mainPage: document.getElementById('main-page'),
      settingsPage: document.getElementById('settings-page'),
      // inputs
      latitudeInput: document.getElementById('latitude-input'),
      dateInput: document.getElementById('date-input'),
      getLocationButton: document.getElementById('get-location'),
      locationSubtitle: document.getElementById('location-subtitle'),
      locationError: document.getElementById('location-error'),
      // sensors
      activateSensorsButton: document.getElementById('activate-sensors-button'),
      manualEntryButton: document.getElementById('manual-entry-button'),
      sensorsDisplay: document.getElementById('sensors-display'),
      currentAngleDisplay: document.getElementById('current-angle'),
      currentCompassDisplay: document.getElementById('current-compass'),
      memorizeRing: document.getElementById('memorize-ring'),
      memorizeRingLabel: document.getElementById('memorize-ring-label'),
      sensorError: document.getElementById('sensor-error'),
      // manual
      manualEntryDisplay: document.getElementById('manual-entry-display'),
      manualTiltInput: document.getElementById('manual-tilt-input'),
      manualAzimuthInput: document.getElementById('manual-azimuth-input'),
      // results
      resultContainer: document.getElementById('result-container'),
      resultDisplay: document.getElementById('result'),
      seasonalContainer: document.getElementById('seasonal-container'),
      winterAngleDisplay: document.getElementById('winter-angle'),
      springFallAngleDisplay: document.getElementById('spring-fall-angle'),
      summerAngleDisplay: document.getElementById('summer-angle'),
      gotoEstimationButton: document.getElementById('goto-estimation-button'),
      // settings page
      backButton: document.getElementById('back-button'),
      peakPowerInput: document.getElementById('peak-power'),
      longitudeInput: document.getElementById('longitude-input'),
      currentTiltInput: document.getElementById('current-tilt-input'),
      currentAzimuthInput: document.getElementById('current-azimuth-input'),
      calculateProductionButton: document.getElementById('calculate-production'),
      productionResults: document.getElementById('production-results'),
      currentProductionDisplay: document.getElementById('current-production'),
      optimalProductionDisplay: document.getElementById('optimal-production'),
      potentialGainDisplay: document.getElementById('potential-gain'),
      potentialGainMonthlyDisplay: document.getElementById('potential-gain-monthly'),
      pvgisError: document.getElementById('pvgis-error'),
      calculateText: document.getElementById('calculate-text'),
      calculateLoader: document.getElementById('calculate-loader'),
      exportPdfBtn: document.getElementById('export-pdf-btn'),
      // footer buttons
      bugReportButton: document.getElementById('bug-report-button'),
      donateButtonFab: document.getElementById('donate-button-fab')
    };

    const utils = {
      toRad:(d)=>d*Math.PI/180,
      toDeg:(r)=>r*180/Math.PI,
      clamp:(x,min,max)=>Math.min(Math.max(x,min),max),
      formatNumber:(n,dec=2)=>{
        const loc = (i18n.currentLang==='fr')?'fr-FR':'en-US';
        return Number(n).toLocaleString(loc,{minimumFractionDigits:dec,maximumFractionDigits:dec});
      },
      safeParseFloat:(v,fb=NaN)=>{ if(v==null||v==='') return fb; const s=String(v).replace(',','.').trim(); const n=parseFloat(s); return Number.isFinite(n)?n:fb;},
      getDayOfYear:(d)=>Math.floor((d - new Date(d.getFullYear(),0,0))/86400000),
      getDeclination:(N)=> -23.44 * Math.cos(utils.toRad((360/365)*(N+10))) // simple & robust
    };

    const ui = {
      showPage(page){
        dom.mainPage.classList.toggle('hidden', page!=='main');
        dom.settingsPage.classList.toggle('hidden', page!=='settings');
      },
      updateLocationFields(lat, lon){
        dom.latitudeInput.value = lat; state.currentLongitude = lon; dom.longitudeInput.value = lon;
        dom.locationSubtitle.textContent = `Lat ${utils.formatNumber(lat,4)} Lon ${utils.formatNumber(lon,4)}`;
        dom.locationError.textContent=''; calculations.calculateAndDisplayAll();
        try{ localStorage.setItem('userLocation', JSON.stringify({lat, lon})); }catch{}
      },
      setEntryMode(mode){
        state.entryMode = mode;
        if(mode==='sensors'){
          dom.sensorsDisplay.classList.remove('hidden');
          dom.manualEntryDisplay.classList.add('hidden');
          dom.activateSensorsButton.classList.add('btn-danger');
          dom.activateSensorsButton.classList.remove('btn-primary');
          dom.manualEntryButton.classList.add('btn-secondary');
          dom.memorizeRing.classList.add('paused');
          dom.memorizeRingLabel.textContent = translations[i18n.currentLang].memorize_action;
          sensors.start();
        } else if(mode==='manual'){
          if(state.sensorsActive) sensors.stop();
          dom.sensorsDisplay.classList.add('hidden');
          dom.manualEntryDisplay.classList.remove('hidden');
          dom.activateSensorsButton.classList.add('btn-primary');
          dom.activateSensorsButton.classList.remove('btn-danger');
          dom.gotoEstimationButton.classList.remove('hidden');
        }
        calculations.calculateAndDisplayAll();
      }
    };

    // Haptics helper
    async function vibrateFeedback(ms=80){
      try{
        const H = window.Capacitor?.Plugins?.Haptics;
        if(H && typeof H.impact==='function'){
          await H.impact({ style: 'Medium' });
          return true;
        }
      }catch(_){/* ignore */}
      if('vibrate' in navigator){ navigator.vibrate(ms); return true; }
      return false;
    }

    const calculations = {
      calculateAndDisplayAll(){
        const dateValue = dom.dateInput.value;
        const lat = utils.safeParseFloat(dom.latitudeInput.value);
        let panelAzDev = NaN;
        if(state.entryMode==='manual'){
          panelAzDev = utils.safeParseFloat(dom.manualAzimuthInput.value);
        }else if(state.entryMode==='sensors' && state.sensorsActive && state.panelAzimuthLive!=null){
          let dev = state.panelAzimuthLive - 180; if(dev>180) dev-=360; if(dev<-180) dev+=360; panelAzDev = dev;
        }
        if(!dateValue || isNaN(lat) || isNaN(panelAzDev)){
          if(state.entryMode!=='sensors') dom.resultContainer.classList.add('hidden');
          dom.seasonalContainer.classList.add('hidden');
          return;
        }
        dom.resultContainer.classList.remove('hidden');
        dom.seasonalContainer.classList.remove('hidden');

        const d = new Date(dateValue);
        const N = utils.getDayOfYear(d);
        const decl = utils.getDeclination(N);
        const solarNoonAlt = 90 - Math.abs(lat - decl);
        let optimalTilt = 90 - solarNoonAlt; // = |lat - decl|

        // clipping by solar season (decl>10 ‚Üí late spring to mid-summer)
        const clipping = (decl>10)? CONFIG.clippingAdjustment : 0;

        // azimuth penalty (capped), slightly season-weighted
        const dev = Math.abs(panelAzDev);
        const basePenalty = Math.min(6, dev/12); // max 6¬∞
        const seasonWeight = 0.7 + 0.3 * (Math.abs(decl)/23.44); // winter a bit stronger
        const penalty = basePenalty * seasonWeight;

        optimalTilt = utils.clamp(optimalTilt + clipping - penalty, 0, 90);

        state.lastRecommendedTilt = Math.round(optimalTilt*10)/10; // keep 0.1¬∞ internally
        dom.resultDisplay.textContent = `${Math.round(optimalTilt)}¬∞`;

        // Seasonal cards using declination-scaled ¬±f
        const f = Math.round((Math.abs(decl)/23.44)*15);
        dom.winterAngleDisplay.textContent = `${Math.round(lat + f - penalty)}¬∞`;
        dom.springFallAngleDisplay.textContent = `${Math.round(lat - penalty)}¬∞`;
        dom.summerAngleDisplay.textContent = `${Math.round((lat - f + clipping) - penalty)}¬∞`;
      }
    };

    const sensors = {
      getTiltFromEvent(e){ if(e.beta==null) return null; const t = Math.abs(e.beta - state.tiltOffset); return utils.clamp(Math.round(t),0,90); },
      getHeadingFromEvent(e){
        if(typeof e.webkitCompassHeading === 'number') return e.webkitCompassHeading; // absolute
        if(typeof e.alpha !== 'number') return null;
        const screenAngle = (screen.orientation?.angle)|| window.orientation || 0;
        let heading = (360 - e.alpha + screenAngle) % 360; if(heading<0) heading+=360; return heading;
      },
      formatAzimuthForDisplay(az){ let dev = az-180; if(dev>180) dev-=360; if(dev<-180) dev+=360; const L=i18n.currentLang; if(Math.abs(dev)<5) return translations[L].compass_south; const dir = dev<0? translations[L].compass_east: translations[L].compass_west; return `${Math.round(Math.abs(dev))}¬∞ ${dir}`; },
      handleOrientation(event){
        const now = performance.now(); if(now-state.lastSensorTs<100) return; state.lastSensorTs=now; // throttle 10Hz
        const tilt = sensors.getTiltFromEvent(event);
        const head = sensors.getHeadingFromEvent(event);
        if(tilt!=null){ dom.currentAngleDisplay.textContent = tilt; dom.sensorError.textContent=''; }
        if(head!=null){ state.panelAzimuthLive = ((head%360)+360)%360; dom.currentCompassDisplay.textContent = sensors.formatAzimuthForDisplay(state.panelAzimuthLive); }

        // stability buffer & ring state
        if(tilt!=null){
          const buf = state.stabilityBuf; buf.push(tilt); if(buf.length>7) buf.shift();
          if(buf.length>=5){
            const avg = buf.reduce((a,b)=>a+b,0)/buf.length; const sd = Math.sqrt(buf.reduce((s,x)=>s+Math.pow(x-avg,2),0)/buf.length);
            const stable = sd < 0.8; // ~¬±0.8¬∞
            dom.memorizeRing.classList.toggle('ok', stable);
            dom.memorizeRing.classList.toggle('paused', !stable);
            dom.memorizeRingLabel.textContent = stable? translations[i18n.currentLang].memorize_action : translations[i18n.currentLang].memorize_action_info;
            dom.memorizeRing.style.cursor = stable? 'pointer':'not-allowed';
            dom.memorizeRing.dataset.enabled = stable? '1':'0';
          }
        }
        calculations.calculateAndDisplayAll();
      },
      async start(){
        if(state.sensorsActive){ sensors.stop(); return; }
        dom.sensorError.textContent = 'Activation‚Ä¶';
        try{
          window.addEventListener(CONFIG.sensorEventName, sensors.handleOrientation, true);
          state.sensorsActive = true; dom.activateSensorsButton.textContent = translations[i18n.currentLang].stop_sensors; dom.gotoEstimationButton.classList.remove('hidden');
        }catch(err){ dom.sensorError.textContent='Capteurs indisponibles.'; }
      },
      stop(){
        if(!state.sensorsActive) return;
        window.removeEventListener(CONFIG.sensorEventName, sensors.handleOrientation, true);
        state.sensorsActive=false; state.panelAzimuthLive=null; state.stabilityBuf.length=0; dom.activateSensorsButton.textContent = translations[i18n.currentLang].activate_sensors; dom.currentAngleDisplay.textContent='--'; dom.currentCompassDisplay.textContent='--'; dom.memorizeRing.classList.add('paused'); dom.memorizeRing.classList.remove('ok'); dom.memorizeRingLabel.textContent = translations[i18n.currentLang].memorize_action; calculations.calculateAndDisplayAll();
      }
    };

    const handlers = {
      async memorizeSensorValues(){
        if(dom.memorizeRing.dataset.enabled!=='1'){ return; }
        const tilt = parseInt(dom.currentAngleDisplay.textContent,10);
        const az = state.panelAzimuthLive;
        if(!Number.isFinite(tilt) || !Number.isFinite(az)){
          dom.sensorError.textContent = translations[i18n.currentLang].invalid_measurements; return;
        }
        state.memorizedTilt = tilt; state.memorizedAzimuthValue = az; state.memorizedLongitude = state.currentLongitude;
        // ring shockwave + haptic
        document.getElementById('ring-wave').classList.remove('run'); void dom.memorizeRing.offsetWidth; document.getElementById('ring-wave').classList.add('run');
        await vibrateFeedback(90);
        dom.memorizeRingLabel.textContent = translations[i18n.currentLang].memorized;
        setTimeout(()=>{ dom.memorizeRingLabel.textContent = translations[i18n.currentLang].memorize_action; }, 1600);
      },
      prepareEstimationPage(){
        if(state.entryMode==='manual'){
          dom.currentTiltInput.value = dom.manualTiltInput.value;
          dom.currentAzimuthInput.value = dom.manualAzimuthInput.value;
        }else{
          dom.currentTiltInput.value = state.memorizedTilt ?? '';
          if(state.memorizedAzimuthValue!=null){ let dev = state.memorizedAzimuthValue-180; if(dev>180) dev-=360; if(dev<-180) dev+=360; dom.currentAzimuthInput.value = Math.round(dev); } else { dom.currentAzimuthInput.value=''; }
        }
        dom.longitudeInput.value = state.currentLongitude;
        ui.showPage('settings');
      },
      openBugReport(e){ e.preventDefault(); const subject = 'Suggestion / Bug pour Opti Solar'; window.location.href = `mailto:${CONFIG.reportEmail}?subject=${encodeURIComponent(subject)}`; },
      openDonate(e){ e.preventDefault(); window.open(CONFIG.donateLink,'_blank','noopener'); }
    };

    const api = {
      async fetchWithTimeout(resource, options={}){
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), options.timeout || 8000);
        try{ return await fetch(resource, { ...options, signal: controller.signal }); } finally { clearTimeout(t); }
      },
      async fetchPVGIS(lat, lon, peakpower, angle, aspect){
        const base = `https://re.jrc.ec.europa.eu/api/PVcalc?lat=${lat}&lon=${lon}&peakpower=${peakpower}&loss=14&angle=${angle}&aspect=${aspect}&outputformat=json`;
        const key = `pvgis:${lat}:${lon}:${peakpower}:${angle}:${aspect}`;
        try{ const cached = sessionStorage.getItem(key); if(cached){ return JSON.parse(cached); } }catch{}
        const strats = [
          async()=>{ const url=`https://api.allorigins.win/json?url=${encodeURIComponent(base)}`; const r=await api.fetchWithTimeout(url,{timeout:8000}); if(!r.ok) throw new Error('allorigins'); const j=await r.json(); return JSON.parse(j.contents); },
          async()=>{ const url=`https://corsproxy.io/?${encodeURIComponent(base)}`; const r=await api.fetchWithTimeout(url,{timeout:8000}); if(!r.ok) throw new Error('corsproxy'); return await r.json(); },
          async()=>{ const r=await api.fetchWithTimeout(base,{timeout:5000}); if(!r.ok) throw new Error('direct'); return await r.json(); }
        ];
        for(let i=0;i<strats.length;i++){ try{ const json = await strats[i](); if(json?.outputs?.totals?.fixed){ try{ sessionStorage.setItem(key, JSON.stringify(json)); }catch{} return json; } }catch(e){} }
        throw new Error('All PVGIS fetch strategies failed');
      },
      async getProductionEstimate(){
        dom.pvgisError.textContent=''; dom.productionResults.classList.add('hidden'); dom.calculateLoader.classList.remove('hidden'); dom.calculateText.classList.add('hidden');
        const lat = utils.safeParseFloat(dom.latitudeInput.value);
        const lon = utils.safeParseFloat(dom.longitudeInput.value);
        const peakPower = utils.safeParseFloat(dom.peakPowerInput.value);
        const currentTilt = utils.safeParseFloat(dom.currentTiltInput.value);
        const currentAz = utils.safeParseFloat(dom.currentAzimuthInput.value);
        if([lat,lon,peakPower,currentTilt,currentAz].some(v=>isNaN(v))){ dom.pvgisError.textContent = (translations[i18n.currentLang].invalid_measurements); dom.calculateLoader.classList.add('hidden'); dom.calculateText.classList.remove('hidden'); return; }
        try{
          const d = new Date(dom.dateInput.value); const N=utils.getDayOfYear(d); const decl=utils.getDeclination(N); const clipping=(decl>10)?CONFIG.clippingAdjustment:0; const trueOpt = Math.abs(lat - decl); const finalTilt = Math.round(trueOpt + clipping);
          const [cur,opt] = await Promise.all([
            api.fetchPVGIS(lat,lon,peakPower,currentTilt,currentAz),
            api.fetchPVGIS(lat,lon,peakPower,finalTilt,0)
          ]);
          let curD=Number(cur.outputs.totals.fixed.E_d)||0, optD=Number(opt.outputs.totals.fixed.E_d)||0; let curM=Number(cur.outputs.totals.fixed.E_m)||0, optM=Number(opt.outputs.totals.fixed.E_m)||0;
          if(optD<curD){ optD=curD; optM=curM; dom.pvgisError.textContent=''; }
          dom.currentProductionDisplay.textContent = `${utils.formatNumber(curD)} kWh`;
          dom.optimalProductionDisplay.textContent = `${utils.formatNumber(optD)} kWh`;
          const gainD = optD-curD; dom.potentialGainDisplay.textContent = gainD<1? `~ ${Math.round(gainD*1000)} Wh` : `~ ${utils.formatNumber(gainD)} kWh`;
          const gainM = optM-curM; dom.potentialGainMonthlyDisplay.textContent = `~ ${utils.formatNumber(gainM)} kWh`;
          dom.productionResults.classList.remove('hidden');
        }catch(e){ dom.pvgisError.textContent = translations[i18n.currentLang].pvgis_error; }
        finally{ dom.calculateLoader.classList.add('hidden'); dom.calculateText.classList.remove('hidden'); }
      },
      exportPdf(){
        if(dom.productionResults.classList.contains('hidden')){ alert(translations[i18n.currentLang].export_error_no_data); return; }
        const node = dom.productionResults;
        const opt = { margin:10, filename:`OptiSolar_${Date.now()}.pdf`, image:{ type:'jpeg', quality:0.95 }, html2canvas:{ scale:2 }, jsPDF:{ unit:'pt', format:'a4', orientation:'portrait' } };
        html2pdf().from(node).set(opt).save();
      }
    };

    function init(){
      // onboarding language/location restore
      try{ const savedLang = localStorage.getItem('userLang'); if(savedLang) i18n.setLanguage(savedLang); }catch{}
      const today = new Date(); dom.dateInput.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      dom.latitudeInput.value = CONFIG.defaultLatitude; dom.longitudeInput.value = CONFIG.defaultLongitude;
      try{ const loc = JSON.parse(localStorage.getItem('userLocation')||'null'); if(loc && loc.lat && loc.lon){ ui.updateLocationFields(loc.lat, loc.lon); } }catch{}

      // listeners
      ['change','input'].forEach(evt=>{
        dom.latitudeInput.addEventListener(evt, calculations.calculateAndDisplayAll);
        dom.dateInput.addEventListener(evt, calculations.calculateAndDisplayAll);
        dom.manualTiltInput.addEventListener(evt, calculations.calculateAndDisplayAll);
        dom.manualAzimuthInput.addEventListener(evt, calculations.calculateAndDisplayAll);
      });

      dom.activateSensorsButton.addEventListener('click', ()=>{ state.sensorsActive? sensors.stop(): ui.setEntryMode('sensors'); });
      dom.manualEntryButton.addEventListener('click', ()=> ui.setEntryMode('manual'));
      dom.memorizeRing.addEventListener('click', handlers.memorizeSensorValues);

      dom.getLocationButton.addEventListener('click', ()=>{
        dom.locationError.textContent = 'Obtention‚Ä¶';
        if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=> ui.updateLocationFields(p.coords.latitude, p.coords.longitude), err=> dom.locationError.textContent = 'Impossible d\'obtenir la position.'); } else { dom.locationError.textContent='G√©olocalisation non support√©e.'; }
      });

      dom.gotoEstimationButton.addEventListener('click', handlers.prepareEstimationPage);
      dom.backButton.addEventListener('click', ()=> ui.showPage('main'));
      dom.calculateProductionButton.addEventListener('click', api.getProductionEstimate);
      dom.exportPdfBtn.addEventListener('click', api.exportPdf);

      // language switch
      document.querySelectorAll('#lang-switcher [data-lang]').forEach(btn=> btn.addEventListener('click', e=> i18n.setLanguage(e.currentTarget.dataset.lang)));

      // footer actions
      dom.bugReportButton.addEventListener('click', handlers.openBugReport);
      dom.donateButtonFab.addEventListener('click', handlers.openDonate);

      // initial language
      i18n.setLanguage('fr');
    }

    window.addEventListener('load', init);
  })();
  </script>
</body>
</html>
